// --- SITEMAP ROUTE ---
import slugify from 'slugify';

app.get('/sitemap.xml', async (req, res) => {
    try {
        const baseUrl = process.env.FRONTEND_URL?.replace(/\/$/, '') || 'https://www.esmakeupstore.com';

        const [categories, subCategories, products] = await Promise.all([
            CategoryModel.find(),
            SubCategoryModel.find(),
            ProductModel.find({ publish: true })
        ]);

        function escapeXml(unsafe) {
            return unsafe ? unsafe.replace(/[<>&'"]/g, function (c) {
                switch (c) {
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '&': return '&amp;';
                    case '\'': return '&apos;';
                    case '"': return '&quot;';
                }
            }) : '';
        }
        function formatDate(date) {
            if (!date) return '';
            const d = (typeof date === 'string') ? new Date(date) : date;
            return d.toISOString().split('T')[0];
        }
        function valideURLConvert(name) {
            return slugify(name, { lower: true, strict: true });
        }

        let urls = [
            `<url>
                <loc>${baseUrl}/</loc>
                <changefreq>daily</changefreq>
            </url>`,
            `<url>
                <loc>${baseUrl}/about</loc>
                <changefreq>monthly</changefreq>
            </url>`,
            `<url>
                <loc>${baseUrl}/contact</loc>
                <changefreq>monthly</changefreq>
            </url>`,
            `<url>
                <loc>${baseUrl}/new-arrival</loc>
                <changefreq>monthly</changefreq>
            </url>`,
            `<url>
                <loc>${baseUrl}/brands</loc>
                <changefreq>monthly</changefreq>
            </url>`
        ];

        // Categories
        for (const cat of categories) {
            const catUrl = `${baseUrl}/${valideURLConvert(cat.name)}-${cat._id}`;
            urls.push(
                `<url>
                    <loc>${catUrl}</loc>
                    ${cat.updatedAt ? `<lastmod>${formatDate(cat.updatedAt)}</lastmod>` : ''}
                    <changefreq>weekly</changefreq>
                    ${cat.image ? `<image:image><image:loc>${escapeXml(cat.image)}</image:loc></image:image>` : ''}
                </url>`
            );
        }

        // SubCategories
        for (const sub of subCategories) {
            const parentCat = categories.find(c => String(c._id) === String(sub.category[0]));
            if (!parentCat) continue;
            const subUrl = `${baseUrl}/${valideURLConvert(parentCat.name)}-${parentCat._id}/${valideURLConvert(sub.name)}-${sub._id}`;
            urls.push(
                `<url>
                    <loc>${subUrl}</loc>
                    ${sub.updatedAt ? `<lastmod>${formatDate(sub.updatedAt)}</lastmod>` : ''}
                    <changefreq>weekly</changefreq>
                    ${sub.image ? `<image:image><image:loc>${escapeXml(sub.image)}</image:loc></image:image>` : ''}
                </url>`
            );
        }

        // Products
        for (const prod of products) {
            const sub = subCategories.find(s => String(s._id) === String(prod.subCategory[0]));
            const cat = sub ? categories.find(c => String(c._id) === String(sub.category[0])) : null;
            let prodUrl;
            if (cat && sub) {
                prodUrl = `${baseUrl}/${valideURLConvert(cat.name)}-${cat._id}/${valideURLConvert(sub.name)}-${sub._id}/${valideURLConvert(prod.name)}-${prod._id}`;
            } else {
                prodUrl = `${baseUrl}/product/${prod._id}`;
            }

            let imageTags = '';
            if (Array.isArray(prod.image)) {
                imageTags = prod.image
                    .filter(img => !!img)
                    .map(imgUrl => `<image:image><image:loc>${escapeXml(imgUrl)}</image:loc></image:image>`)
                    .join('\n');
            }
            urls.push(
                `<url>
                    <loc>${prodUrl}</loc>
                    ${prod.updatedAt ? `<lastmod>${formatDate(prod.updatedAt)}</lastmod>` : ''}
                    <changefreq>weekly</changefreq>
                    ${imageTags}
                </url>`
            );
        }

        // Final XML
        const xml = `<?xml version="1.0" encoding="UTF-8"?>
<urlset 
    xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"
    xmlns:image="http://www.google.com/schemas/sitemap-image/1.1">
${urls.join('\n')}
</urlset>`;

        res.header('Content-Type', 'application/xml');
        res.send(xml);
    } catch (error) {
        console.error('Sitemap error:', error);
        res.status(500).send('Could not generate sitemap');
    }
});